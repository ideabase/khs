{"version":3,"sources":["RedactorInput.js"],"names":["$","Craft","RedactorInput","Garnish","Base","extend","id","linkOptions","volumes","elementSiteId","redactorConfig","$textarea","redactor","linkOptionModals","init","settings","this","transforms","lang","redactorLang","direction","orientation","imageUpload","fileUpload","dragImageUpload","dragFileUpload","plugins","buttons","index","inArray","splice","unshift","lowestListButtonIndex","oldListButtons","i","length","callbacks","handleRedactorInit","initRedactor","livePreview","on","proxy","core","destroy","mergeCallbacks","callback1","callback2","apply","arguments","toolbarFixed","target","closest","toolbarFixedTarget","currentInstance","onInitRedactor","$box","addClass","opts","toolbar","customizeToolbar","leaveFullscreetOnSaveShortcut","editor","scrollPageOnReady","$doc","ready","trigger","$imageBtn","replaceRedactorButton","get","$fileBtn","button","addCallback","remove","$linkBtn","dropdownOptions","title","optionTitle","func","link","observe","element","in","out","unlink","attr","class","aria-disabled","addDropdown","onImageButtonClick","selection","save","assetSelectionModal","createElementSelectorModal","storageKey","multiSelect","sources","criteria","siteId","kind","onSelect","assets","transform","restore","asset","url","insert","node","imageTag","code","sync","images","closeOtherModals","show","onFileButtonClick","assetLinkSelectionModal","text","label","onLinkOptionClick","key","elementType","elements","refHandle","onEditorFocus","box","onEditorBlur","removeClass","fullscreen","disable","cp","isOpen","$placeholder","addAfter","$btn","build","icon","parent","after","append","jQuery"],"mappings":"CAAA,SAAUA,GAMNC,MAAMC,cAAgBC,QAAQC,KAAKC,QAE3BC,GAAI,KACJC,YAAa,KACbC,QAAS,KACTC,cAAe,KACfC,eAAgB,KAEhBC,UAAW,KACXC,SAAU,KACVC,iBAAkB,KAElBC,KAAM,SAASC,GA6BX,GA5BAC,KAAKV,GAAKS,EAAST,GACnBU,KAAKT,YAAcQ,EAASR,YAC5BS,KAAKR,QAAUO,EAASP,QACxBQ,KAAKC,WAAaF,EAASE,WAC3BD,KAAKP,cAAgBM,EAASN,cAC9BO,KAAKN,eAAiBK,EAASL,eAE/BM,KAAKH,oBAEAG,KAAKN,eAAeQ,OACrBF,KAAKN,eAAeQ,KAAOH,EAASI,cAGnCH,KAAKN,eAAeU,YACrBJ,KAAKN,eAAeU,UAAaL,EAASK,WAAanB,MAAMoB,aAGjEL,KAAKN,eAAeY,aAAc,EAClCN,KAAKN,eAAea,YAAa,EACjCP,KAAKN,eAAec,iBAAkB,EACtCR,KAAKN,eAAee,gBAAiB,SAG1BT,KAAKN,eAAegB,oBAC3BV,KAAKN,eAAegB,YAIpBV,KAAKN,eAAeiB,QAAS,CAC7B,IAAIC,GAG8D,KAA7DA,EAAQ5B,EAAE6B,QAAQ,OAAQb,KAAKN,eAAeiB,YAC/CX,KAAKN,eAAeiB,QAAQG,OAAOF,EAAO,GAC1CZ,KAAKN,eAAegB,QAAQK,QAAQ,YAIgC,KAAnEH,EAAQ5B,EAAE6B,QAAQ,aAAcb,KAAKN,eAAeiB,WACrDX,KAAKN,eAAeiB,QAAQG,OAAOF,EAAO,EAAG,UAOjD,IAHA,IACII,EADAC,GAAkB,gBAAiB,cAAe,SAAU,UAGvDC,EAAI,EAAGA,EAAID,EAAeE,OAAQD,KACsC,KAAxEN,EAAQ5B,EAAE6B,QAAQI,EAAeC,GAAIlB,KAAKN,eAAeiB,YAC1DX,KAAKN,eAAeiB,QAAQG,OAAOF,EAAO,SAEL,IAA1BI,GAAyCJ,EAAQI,KACxDA,EAAwBJ,SAKC,IAA1BI,GACPhB,KAAKN,eAAeiB,QAAQG,OAAOE,EAAuB,EAAG,SAIrEhB,KAAKN,eAAe0B,WAChBtB,KAAMb,MAAMC,cAAcmC,oBAI9BrB,KAAKL,UAAYX,EAAE,IAAMgB,KAAKV,IAE9BU,KAAKsB,oBAE4B,IAAtBrC,MAAMsC,cAEbtC,MAAMsC,YAAYC,GAAG,yBAA0BxC,EAAEyC,MAAM,WACnDzB,KAAKJ,SAAS8B,KAAKC,WACpB3B,OAEHf,MAAMsC,YAAYC,GAAG,iBAAkBxC,EAAEyC,MAAM,WAC3CzB,KAAKsB,gBACNtB,SAIX4B,eAAgB,SAASC,EAAWC,GAChC,OAAO,WACHD,EAAUE,MAAM/B,KAAMgC,WACtBF,EAAUC,MAAM/B,KAAMgC,aAI9BV,aAAc,WACV,GAAItB,KAAKN,eAAeuC,aAAc,CAElC,IAAIC,EAASlC,KAAKL,UAAUwC,QAAQ,kCAChCD,EAAOf,SACPnB,KAAKN,eAAe0C,mBAAqBF,IAIjDjD,MAAMC,cAAcmD,gBAAkBrC,MACjCL,UAAUC,SAASI,KAAKN,uBACtBT,MAAMC,cAAcmD,iBAG/BC,eAAgB,SAAS1C,GACrBI,KAAKJ,SAAWA,EAGhBI,KAAKJ,SAAS2C,KAAKC,SAAS,mBAIxBxC,KAAKJ,SAAS6C,KAAKC,SACnB1C,KAAK2C,mBAGT3C,KAAK4C,gCAEL5C,KAAKJ,SAAS8B,KAAKmB,SACdrB,GAAG,QAASxC,EAAEyC,MAAMzB,KAAM,kBAC1BwB,GAAG,OAAQxC,EAAEyC,MAAMzB,KAAM,iBAE1BA,KAAKJ,SAAS6C,KAAKR,eAAiBhD,MAAMC,cAAc4D,oBACxD3D,QAAQ4D,KAAKC,MAAM,WACf7D,QAAQ4D,KAAKE,QAAQ,YAGzBhE,MAAMC,cAAc4D,mBAAoB,IAIhDH,iBAAkB,WAEd,GAAI3C,KAAKR,QAAQ2B,OAAQ,CACrB,IAAI+B,EAAYlD,KAAKmD,sBAAsB,QAASnD,KAAKJ,SAASM,KAAKkD,IAAI,UACvEC,EAAWrD,KAAKmD,sBAAsB,OAAQnD,KAAKJ,SAASM,KAAKkD,IAAI,SAErEF,GACAlD,KAAKJ,SAAS0D,OAAOC,YAAYL,EAAWlE,EAAEyC,MAAMzB,KAAM,uBAG1DqD,GACArD,KAAKJ,SAAS0D,OAAOC,YAAYF,EAAUrE,EAAEyC,MAAMzB,KAAM,2BAK7DA,KAAKJ,SAAS0D,OAAOE,OAAO,SAC5BxD,KAAKJ,SAAS0D,OAAOE,OAAO,QAIhC,GAAIxD,KAAKT,YAAY4B,OAAQ,CACzB,IAAIsC,EAAWzD,KAAKmD,sBAAsB,OAAQnD,KAAKJ,SAASM,KAAKkD,IAAI,SAEzE,GAAIK,EAAU,CAGV,IAFA,IAAIC,KAEKxC,EAAI,EAAGA,EAAIlB,KAAKT,YAAY4B,OAAQD,IACzCwC,EAAgB,cAAgBxC,IAC5ByC,MAAO3D,KAAKT,YAAY2B,GAAG0C,YAC3BC,KAAM7E,EAAEyC,MAAMzB,KAAM,oBAAqBkB,IAKjDlC,EAAEK,OAAOqE,GACLI,MACIH,MAAO3D,KAAKJ,SAASM,KAAKkD,IAAI,eAC9BS,KAAM,YACNE,SACIC,QAAS,IACTC,IACIN,MAAO3D,KAAKJ,SAASM,KAAKkD,IAAI,cAElCc,KACIP,MAAO3D,KAAKJ,SAASM,KAAKkD,IAAI,kBAI1Ce,QACIR,MAAO3D,KAAKJ,SAASM,KAAKkD,IAAI,UAC9BS,KAAM,cACNE,SACIC,QAAS,IACTE,KACIE,MACIC,MAAS,kCACTC,iBAAiB,QAOrCtE,KAAKJ,SAAS0D,OAAOiB,YAAYd,EAAUC,MAKvDc,mBAAoB,WAChBxE,KAAKJ,SAAS6E,UAAUC,YAEgB,IAA7B1E,KAAK2E,oBACZ3E,KAAK2E,oBAAsB1F,MAAM2F,2BAA2B,0BACxDC,WAAY,4BACZC,aAAa,EACbC,QAAS/E,KAAKR,QACdwF,UAAWC,OAAQjF,KAAKP,cAAeyF,KAAM,SAC7CC,SAAUnG,EAAEyC,MAAM,SAAS2D,EAAQC,GAC/B,GAAID,EAAOjE,OAAQ,CACfnB,KAAKJ,SAAS6E,UAAUa,UACxB,IAAK,IAAIpE,EAAI,EAAGA,EAAIkE,EAAOjE,OAAQD,IAAK,CACpC,IAAIqE,EAAQH,EAAOlE,GACfsE,EAAMD,EAAMC,IAAM,UAAYD,EAAMjG,GAEpC+F,IACAG,GAAO,cAAgBH,GAG3BrF,KAAKJ,SAAS6F,OAAOC,KAAK1G,EAAE,IAAMgB,KAAKJ,SAAS6C,KAAKkD,SAAW,cAAgBH,EAAM,iBAAiB,IACvGxF,KAAKJ,SAASgG,KAAKC,OAEvB7F,KAAKJ,SAASmE,QAAQ+B,WAE3B9F,MACH+F,kBAAkB,EAClB9F,WAAYD,KAAKC,aAIrBD,KAAK2E,oBAAoBqB,QAIjCC,kBAAmB,WACfjG,KAAKJ,SAAS6E,UAAUC,YAEoB,IAAjC1E,KAAKkG,wBACZlG,KAAKkG,wBAA0BjH,MAAM2F,2BAA2B,0BAC5DC,WAAY,4BACZE,QAAS/E,KAAKR,QACdwF,UAAWC,OAAQjF,KAAKP,eACxB0F,SAAUnG,EAAEyC,MAAM,SAAS2D,GACvB,GAAIA,EAAOjE,OAAQ,CACfnB,KAAKJ,SAAS6E,UAAUa,UACxB,IAAIC,EAAQH,EAAO,GACfI,EAAMD,EAAMC,IAAM,UAAYD,EAAMjG,GACpCmF,EAAYzE,KAAKJ,SAAS6E,UAAU0B,OACpCxC,EAA2B,EAAnBc,EAAUtD,OAAasD,EAAYc,EAAMa,MACrDpG,KAAKJ,SAAS6F,OAAOC,KAAK1G,EAAE,YAAcwG,EAAM,KAAO7B,EAAQ,QAAQ,IACvE3D,KAAKJ,SAASgG,KAAKC,SAExB7F,MACH+F,kBAAkB,EAClB9F,WAAYD,KAAKC,aAIrBD,KAAKkG,wBAAwBF,QAIrCK,kBAAmB,SAASC,GAGxB,GAFAtG,KAAKJ,SAAS6E,UAAUC,YAEkB,IAA/B1E,KAAKH,iBAAiByG,GAAsB,CACnD,IAAIvG,EAAWC,KAAKT,YAAY+G,GAEhCtG,KAAKH,iBAAiByG,GAAOrH,MAAM2F,2BAA2B7E,EAASwG,aACnE1B,WAAa9E,EAAS8E,YAAc,wBAA0B9E,EAASwG,YACvExB,QAAShF,EAASgF,QAClBC,SAAUhG,EAAEK,QAAQ4F,OAAQjF,KAAKP,eAAgBM,EAASiF,UAC1DG,SAAUnG,EAAEyC,MAAM,SAAS+E,GACvB,GAAIA,EAASrF,OAAQ,CACjBnB,KAAKJ,SAAS6E,UAAUa,UACxB,IAAItB,EAAUwC,EAAS,GACnBhB,EAAMxB,EAAQwB,IAAM,IAAMzF,EAAS0G,UAAY,IAAMzC,EAAQ1E,GAC7DmF,EAAYzE,KAAKJ,SAAS6E,UAAU0B,OACpCxC,EAA2B,EAAnBc,EAAUtD,OAAasD,EAAYT,EAAQoC,MACvDpG,KAAKJ,SAAS6F,OAAOC,KAAK1G,EAAE,YAAcwG,EAAM,KAAO7B,EAAQ,QAAQ,IACvE3D,KAAKJ,SAASgG,KAAKC,SAExB7F,MACH+F,kBAAkB,SAItB/F,KAAKH,iBAAiByG,GAAKN,QAInCU,cAAe,WACX1G,KAAKJ,SAAS8B,KAAKiF,MAAMnE,SAAS,SAClCxC,KAAKJ,SAAS8B,KAAKiF,MAAM1D,QAAQ,UAGrC2D,aAAc,WACV5G,KAAKJ,SAAS8B,KAAKiF,MAAME,YAAY,SACrC7G,KAAKJ,SAAS8B,KAAKiF,MAAM1D,QAAQ,SAGrCL,8BAA+B,gBACa,IAA7B5C,KAAKJ,SAASkH,YAA0E,mBAArC9G,KAAKJ,SAASkH,WAAWC,SACnF9H,MAAM+H,GAAGxF,GAAG,qBAAsBxC,EAAEyC,MAAM,WAClCzB,KAAKJ,SAASkH,WAAWG,QACzBjH,KAAKJ,SAASkH,WAAWC,WAE9B/G,QAIXmD,sBAAuB,SAASmD,EAAK3C,GAEjC,GAAK3D,KAAKJ,SAAS0D,OAAOF,IAAIkD,GAAKnF,OAAnC,CAKA,IAAI+F,EAAelH,KAAKJ,SAAS0D,OAAO6D,SAASb,EAAKA,EAAI,gBAG1DtG,KAAKJ,SAAS0D,OAAOE,OAAO8C,GAK5B,IAAIc,EAAOpH,KAAKJ,SAAS0D,OAAO+D,MAAMf,GAClC3C,MAAOA,EACP2D,MAAM,IAOV,OALAJ,EAAaK,SAASC,MAAMxI,EAAE,QAAQyI,OAAOL,IAG7CF,EAAa1D,SAEN4D,MAIX/F,mBAAoB,WAGhBpC,MAAMC,cAAcmD,gBAAgBC,eAAetC,SAzWnE,CA4WG0H","file":"RedactorInput.min.js","sourcesContent":["(function($) {\n    /** global: Craft */\n    /** global: Garnish */\n    /**\n     * Redactor input class\n     */\n    Craft.RedactorInput = Garnish.Base.extend(\n        {\n            id: null,\n            linkOptions: null,\n            volumes: null,\n            elementSiteId: null,\n            redactorConfig: null,\n\n            $textarea: null,\n            redactor: null,\n            linkOptionModals: null,\n\n            init: function(settings) {\n                this.id = settings.id;\n                this.linkOptions = settings.linkOptions;\n                this.volumes = settings.volumes;\n                this.transforms = settings.transforms;\n                this.elementSiteId = settings.elementSiteId;\n                this.redactorConfig = settings.redactorConfig;\n\n                this.linkOptionModals = [];\n\n                if (!this.redactorConfig.lang) {\n                    this.redactorConfig.lang = settings.redactorLang;\n                }\n\n                if (!this.redactorConfig.direction) {\n                    this.redactorConfig.direction = (settings.direction || Craft.orientation);\n                }\n\n                this.redactorConfig.imageUpload = true;\n                this.redactorConfig.fileUpload = true;\n                this.redactorConfig.dragImageUpload = false;\n                this.redactorConfig.dragFileUpload = false;\n\n                // Prevent a JS error when calling core.destroy() when opts.plugins == false\n                if (typeof this.redactorConfig.plugins !== typeof []) {\n                    this.redactorConfig.plugins = [];\n                }\n\n                // Redactor I config setting normalization\n                if (this.redactorConfig.buttons) {\n                    var index;\n\n                    // buttons.html => plugins.source\n                    if ((index = $.inArray('html', this.redactorConfig.buttons)) !== -1) {\n                        this.redactorConfig.buttons.splice(index, 1);\n                        this.redactorConfig.plugins.unshift('source');\n                    }\n\n                    // buttons.formatting => buttons.format\n                    if ((index = $.inArray('formatting', this.redactorConfig.buttons)) !== -1) {\n                        this.redactorConfig.buttons.splice(index, 1, 'format');\n                    }\n\n                    // buttons.unorderedlist/orderedlist/undent/indent => buttons.lists\n                    var oldListButtons = ['unorderedlist', 'orderedlist', 'undent', 'indent'],\n                        lowestListButtonIndex;\n\n                    for (var i = 0; i < oldListButtons.length; i++) {\n                        if ((index = $.inArray(oldListButtons[i], this.redactorConfig.buttons)) !== -1) {\n                            this.redactorConfig.buttons.splice(index, 1);\n\n                            if (typeof lowestListButtonIndex === 'undefined' || index < lowestListButtonIndex) {\n                                lowestListButtonIndex = index;\n                            }\n                        }\n                    }\n\n                    if (typeof lowestListButtonIndex !== 'undefined') {\n                        this.redactorConfig.buttons.splice(lowestListButtonIndex, 0, 'lists');\n                    }\n                }\n\n                this.redactorConfig.callbacks = {\n                    init: Craft.RedactorInput.handleRedactorInit\n                };\n\n                // Initialize Redactor\n                this.$textarea = $('#' + this.id);\n\n                this.initRedactor();\n\n                if (typeof Craft.livePreview !== 'undefined') {\n                    // There's a UI glitch if Redactor is in Code view when Live Preview is shown/hidden\n                    Craft.livePreview.on('beforeEnter beforeExit', $.proxy(function() {\n                        this.redactor.core.destroy();\n                    }, this));\n\n                    Craft.livePreview.on('enter slideOut', $.proxy(function() {\n                        this.initRedactor();\n                    }, this));\n                }\n            },\n\n            mergeCallbacks: function(callback1, callback2) {\n                return function() {\n                    callback1.apply(this, arguments);\n                    callback2.apply(this, arguments);\n                };\n            },\n\n            initRedactor: function() {\n                if (this.redactorConfig.toolbarFixed) {\n                    // Set the toolbarFixedTarget depending on the context\n                    var target = this.$textarea.closest('#content-container, .lp-editor');\n                    if (target.length) {\n                        this.redactorConfig.toolbarFixedTarget = target;\n                    }\n                }\n\n                Craft.RedactorInput.currentInstance = this;\n                this.$textarea.redactor(this.redactorConfig);\n                delete Craft.RedactorInput.currentInstance;\n            },\n\n            onInitRedactor: function(redactor) {\n                this.redactor = redactor;\n\n                // Add the .focusable-input class for Craft.CP\n                this.redactor.$box.addClass('focusable-input');\n\n                // Only customize the toolbar if there is one,\n                // otherwise we get a JS error due to redactor.$toolbar being undefined\n                if (this.redactor.opts.toolbar) {\n                    this.customizeToolbar();\n                }\n\n                this.leaveFullscreetOnSaveShortcut();\n\n                this.redactor.core.editor()\n                    .on('focus', $.proxy(this, 'onEditorFocus'))\n                    .on('blur', $.proxy(this, 'onEditorBlur'));\n\n                if (this.redactor.opts.toolbarFixed && !Craft.RedactorInput.scrollPageOnReady) {\n                    Garnish.$doc.ready(function() {\n                        Garnish.$doc.trigger('scroll');\n                    });\n\n                    Craft.RedactorInput.scrollPageOnReady = true;\n                }\n            },\n\n            customizeToolbar: function() {\n                // Override the Image and File buttons?\n                if (this.volumes.length) {\n                    var $imageBtn = this.replaceRedactorButton('image', this.redactor.lang.get('image')),\n                        $fileBtn = this.replaceRedactorButton('file', this.redactor.lang.get('file'));\n\n                    if ($imageBtn) {\n                        this.redactor.button.addCallback($imageBtn, $.proxy(this, 'onImageButtonClick'));\n                    }\n\n                    if ($fileBtn) {\n                        this.redactor.button.addCallback($fileBtn, $.proxy(this, 'onFileButtonClick'));\n                    }\n                }\n                else {\n                    // Image and File buttons aren't supported\n                    this.redactor.button.remove('image');\n                    this.redactor.button.remove('file');\n                }\n\n                // Override the Link button?\n                if (this.linkOptions.length) {\n                    var $linkBtn = this.replaceRedactorButton('link', this.redactor.lang.get('link'));\n\n                    if ($linkBtn) {\n                        var dropdownOptions = {};\n\n                        for (var i = 0; i < this.linkOptions.length; i++) {\n                            dropdownOptions['link_option' + i] = {\n                                title: this.linkOptions[i].optionTitle,\n                                func: $.proxy(this, 'onLinkOptionClick', i)\n                            };\n                        }\n\n                        // Add the default Link options\n                        $.extend(dropdownOptions, {\n                            link: {\n                                title: this.redactor.lang.get('link-insert'),\n                                func: 'link.show',\n                                observe: {\n                                    element: 'a',\n                                    in: {\n                                        title: this.redactor.lang.get('link-edit')\n                                    },\n                                    out: {\n                                        title: this.redactor.lang.get('link-insert')\n                                    }\n                                }\n                            },\n                            unlink: {\n                                title: this.redactor.lang.get('unlink'),\n                                func: 'link.unlink',\n                                observe: {\n                                    element: 'a',\n                                    out: {\n                                        attr: {\n                                            'class': 'redactor-dropdown-link-inactive',\n                                            'aria-disabled': true\n                                        }\n                                    }\n                                }\n                            }\n                        });\n\n                        this.redactor.button.addDropdown($linkBtn, dropdownOptions);\n                    }\n                }\n            },\n\n            onImageButtonClick: function() {\n                this.redactor.selection.save();\n\n                if (typeof this.assetSelectionModal === 'undefined') {\n                    this.assetSelectionModal = Craft.createElementSelectorModal('craft\\\\elements\\\\Asset', {\n                        storageKey: 'RedactorInput.ChooseImage',\n                        multiSelect: true,\n                        sources: this.volumes,\n                        criteria: {siteId: this.elementSiteId, kind: 'image'},\n                        onSelect: $.proxy(function(assets, transform) {\n                            if (assets.length) {\n                                this.redactor.selection.restore();\n                                for (var i = 0; i < assets.length; i++) {\n                                    var asset = assets[i],\n                                        url = asset.url + '#asset:' + asset.id;\n\n                                    if (transform) {\n                                        url += ':transform:' + transform;\n                                    }\n\n                                    this.redactor.insert.node($('<' + this.redactor.opts.imageTag + '><img src=\"' + url + '\" /></figure>')[0]);\n                                    this.redactor.code.sync();\n                                }\n                                this.redactor.observe.images();\n                            }\n                        }, this),\n                        closeOtherModals: false,\n                        transforms: this.transforms\n                    });\n                }\n                else {\n                    this.assetSelectionModal.show();\n                }\n            },\n\n            onFileButtonClick: function() {\n                this.redactor.selection.save();\n\n                if (typeof this.assetLinkSelectionModal === 'undefined') {\n                    this.assetLinkSelectionModal = Craft.createElementSelectorModal('craft\\\\elements\\\\Asset', {\n                        storageKey: 'RedactorInput.LinkToAsset',\n                        sources: this.volumes,\n                        criteria: {siteId: this.elementSiteId},\n                        onSelect: $.proxy(function(assets) {\n                            if (assets.length) {\n                                this.redactor.selection.restore();\n                                var asset = assets[0],\n                                    url = asset.url + '#asset:' + asset.id,\n                                    selection = this.redactor.selection.text(),\n                                    title = selection.length > 0 ? selection : asset.label;\n                                this.redactor.insert.node($('<a href=\"' + url + '\">' + title + '</a>')[0]);\n                                this.redactor.code.sync();\n                            }\n                        }, this),\n                        closeOtherModals: false,\n                        transforms: this.transforms\n                    });\n                }\n                else {\n                    this.assetLinkSelectionModal.show();\n                }\n            },\n\n            onLinkOptionClick: function(key) {\n                this.redactor.selection.save();\n\n                if (typeof this.linkOptionModals[key] === 'undefined') {\n                    var settings = this.linkOptions[key];\n\n                    this.linkOptionModals[key] = Craft.createElementSelectorModal(settings.elementType, {\n                        storageKey: (settings.storageKey || 'RedactorInput.LinkTo.' + settings.elementType),\n                        sources: settings.sources,\n                        criteria: $.extend({siteId: this.elementSiteId}, settings.criteria),\n                        onSelect: $.proxy(function(elements) {\n                            if (elements.length) {\n                                this.redactor.selection.restore();\n                                var element = elements[0],\n                                    url = element.url + '#' + settings.refHandle + ':' + element.id,\n                                    selection = this.redactor.selection.text(),\n                                    title = selection.length > 0 ? selection : element.label;\n                                this.redactor.insert.node($('<a href=\"' + url + '\">' + title + '</a>')[0]);\n                                this.redactor.code.sync();\n                            }\n                        }, this),\n                        closeOtherModals: false\n                    });\n                }\n                else {\n                    this.linkOptionModals[key].show();\n                }\n            },\n\n            onEditorFocus: function() {\n                this.redactor.core.box().addClass('focus');\n                this.redactor.core.box().trigger('focus');\n            },\n\n            onEditorBlur: function() {\n                this.redactor.core.box().removeClass('focus');\n                this.redactor.core.box().trigger('blur');\n            },\n\n            leaveFullscreetOnSaveShortcut: function() {\n                if (typeof this.redactor.fullscreen !== 'undefined' && typeof this.redactor.fullscreen.disable === 'function') {\n                    Craft.cp.on('beforeSaveShortcut', $.proxy(function() {\n                        if (this.redactor.fullscreen.isOpen) {\n                            this.redactor.fullscreen.disable();\n                        }\n                    }, this));\n                }\n            },\n\n            replaceRedactorButton: function(key, title) {\n                // Ignore if the button isn't in use\n                if (!this.redactor.button.get(key).length) {\n                    return;\n                }\n\n                // Create a placeholder button\n                var $placeholder = this.redactor.button.addAfter(key, key+'_placeholder');\n\n                // Remove the original\n                this.redactor.button.remove(key);\n\n                // Add the new one\n                // (Can't just use button.addAfter() here because it doesn't let us specify\n                // full button properties (e.g. icon); just title)\n                var $btn = this.redactor.button.build(key, {\n                    title: title,\n                    icon: true\n                });\n                $placeholder.parent().after($('<li>').append($btn));\n\n                // Remove the placeholder\n                $placeholder.remove();\n\n                return $btn;\n            }\n        },\n        {\n            handleRedactorInit: function() {\n                // `this` is the current Redactor instance.\n                // `Craft.RedactorInput.currentInstance` is the current RedactorInput instance\n                Craft.RedactorInput.currentInstance.onInitRedactor(this);\n            }\n        });\n})(jQuery);\n"]}